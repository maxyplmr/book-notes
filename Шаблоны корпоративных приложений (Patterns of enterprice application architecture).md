# Расслоение системы

**Концепция слоев (layers)** - Общеупотребительная модель для разделения сложных систем на более простые части.

Слои более высокого уровня пользуются службами, нижних слоев которые не  знают о наличии верхних.

Модификации слоя часто связаны с необходимостью внесения **каскадных изменений** в остальные слои.

Наличие избыточных слоев снижает производительность системы.

### Три основных слоя
 - Представление ( presentation )
 - Бизнес логика / предметная область ( domain )
 - Источник данных ( data source )
 
#### Представление ( presentation )
Охватывает все что имеет отношение пользователя с системой. Главная его функция отображение информации.

#### Бизнес логика / предметная область ( domain )
Описывает основные функции приложения. Вычисления на основе вводимых или хранимых данных, проверка всех элементов данных, обработка команд от слоя представления и передача их к слою источника данных.

#### Источник данных ( data source )
Подмножество функций обеспечивающих взаимодействие с другими сервисами, мониторинг транзакций, управление другими приложениями, обмена сообщениями и тд.
Для большинства корпоративных приложений, основная часть логики код СУБД.

# Организация бизнес логики

### Три типовых решения распределения
 - Сценарий транзакций ( Transaction Script )
 - Модель предметной области ( Domain Model )
 - Модуль таблицы ( Table Model )
 
**Сценарий транзакций** - простейший подход к описанию бизнес логики, связан с процедурой получения информации от слоя представления, 
обрабатывая ее, активизирует операции других систем, выполняет проверки и сохраняет информацию в  БД. Далее процедура возвращает слою представления данные, возможно обрабатывая их.

Преимущества:
- Удобная процедурная модель, легко воспринимать всем разработчикам.
- Сочетание с простыми схемами организации слоя источника данных:
    - Шлюз записи данных ( Row Data Gateway )
    - Шлюз таблицы данных ( Table Data Gateway )
- Определяет четкие границы транзакции

Недостатки:
 - Может возникнуть опасность дублирования фрагментов кода, за счет схожести функций нескольких транзакций

**Модель предметной области** - система абстракций, которая описывает определенные аспекты предметной области.
Обычно реализуется как объектная модель на уровне, который использует более низкий уровень устойчивости 
и публикует API для обеспечения доступа к данным и поведению модели на более высоком уровне.

**Модуль таблицы** - организация логики вокруг таблиц. Эффективность применения зависит от уровня поддержки структуры - множества записей ( .NET )
Преимущества:
- Сочетание с другими аспектами архитектуры. Многие графические сферы работают с результатом обработки СКЛ запроса, организованном в виде записи.
Недостатки:
- Не позволяет использовать многие технологии ( наследование, стратегии ) и тд.  

PS: Нередко на деле **сценарий транзакций** используется для некоторого формирования фрагмента бизнес-логики, а 
**модель предметной области** или **модуль таблицы** - для оставшейся части

**Уровень служб** - подход реализации бизнес-логики состоит в расщеплении слоя предметной области на два самостоятельных слоя.

Сверху над 'модель предметной области' или 'модуль таблицы' располагается - Слой служб

**Слой служб ( Service Layer )** - промежуточный интерфейс который направляет адресуемые ему вызовы к нижележащим объектам. 
Он обеспечивает API, а также берет ответственность за управлениями транзакциями и проверку безопасности.

# Объектные модели и реляционные базы данных

Два основных варианта практического использования типового решения - **Шлюз ( Gataway )**
 Создание экземпляра шлюза применяют  для каждой записи, возвращаемой в результате обработки БД.

- Шлюз записи данных ( Row Data Gateway ) - модель отображающая ОО стиль восприятия реляционных данных
- Множества записей (Record Set) - имитация табличной формы представления содержимого БД, 
для каждой таблицы сопоставить методы активизации запросов возвращающих 'множество записей' класса типа 'шлюз таблицы данных (Table Data Gateway)' 

Шлюз таблицы данных удачно сочетается с Множество записей при использовании **Модуля таблицы данных ( Table Module )**
Шлюз записи данных и шлюз таблицы данных - уместно применять при использовании **Модели предметной области ( Domain Model )**

Изолирование модели предметной области от базы данных чз промежуточный слой - **Переобразователь данных ( Data Mapper )**
При простой логике и высокого соответствия классов и таблиц БД  - типовое решение **Активная запись ( Active Record )**

### Представление связей
 - сохранение связанных объектов применяют решение **Поле идентификации ( Identity Field )**
 - считывание информации из БД для перехода от идентификаторов к объектам используется **Коллекция обьектов ( Identity Map )**  
 - связывание отвечает типовое решение **отображение внешних ключей ( Foreign Key )**
 - связывание 'многие ко многим' преодолевается за счет создания доп. таблицы содержащей пары ключей связанных сущностный - **Отображение с помощью таблицы ассоциаций ( Association Table Mapping )**

### Три основных варианта представления структуры наследование
 - наследование с одной таблицей ( Single Table Inheritance )
	- размещает атрибуты всех базовых классов и интерфейсов в одной большой таблице
 - наследование с таблицами для каждого конкретного класса ( Concrete Table Inheritance )
	- включение данных базовых классов и интерфейсов в каждую таблицу конкретного класса
 - наследование с таблицами для каждого класса ( Class Table Inheritance )
	- создаются таблицы для каждого интерфейса и супер класса
	
### Реализация представления
Отображение обьектов в реляционные структуры:
 - готовой схемы БД нет, ее можно выбирать
 - работа с существующей схемой, и ее нельзя изменять 
 - схема задана, но модификация ее оговаривается дополнительно 
 
Когда схема создается самостоятельно, а бизнес логика умеренно сложная, - оправдан подход 
**Сценарий транзакций ( Transaction Script )** или **Модуль таблицы ( Table Model )**

Для исключения SQL кода и бизнес логики - используют **Шлюз записи данных ( Row Data Gateway )** или **Шлюз таблицы данных ( Table Data Gateway )**

Используя **Модель предметной области ( Domain Model )** - избегать структурирование с оглядкой на БД, больше заботясь о упрощении бизнес логики. 
(БД только как инструмент хранения содержимого бизнес логики, другими словами - решая задачи в первую очередь думаем за модель предметной области, не забывая ее не медленно интегрировать каждую ее часть в БД).

Наибольший уровень гибкости взаимного отображения обьектов и реляционных структур обеспечит - **Переобразователь данных ( Data Mapper )**
(Применение его обладает повышенной сложностью)

Если структура БД и модель предметной области, одинаковы - можно использовать **Активная запись ( Active Record )**

### Использование метаданных 
**Отображение метаданных (Metadata Mapping)** - основано на вынесении функций отображения в файл метаданных,
задающий соответствие между столбами таблиц и полями обьектов.
Преимущества:
 - определение операций считывания и записи
 - автоматическое формирование SQL выражений 
 - поддержка множества записей 


# Представление данных в WEB

**Модель Представление Контроллер (Model View Controller)** - шаблон проектирования, концепция, схема разделения приложения. 

**Контроллер приложения (Application Controller)** - промежуточный слой, между слоем представления и предметной областью, который управляет потоком функций приложения.
(Основная целью применения, отделение бизнес логики )


### Три основных способа представлений
 - Представление с преобразованием ( Transform View )
 - Представление по шаблону ( Template View )
 - Двухэтапное представление ( Two Step View )


# Управление параллельными заданиями 

Два важных контекста взаимодействия программы с внешним миром - это **Запрос ( Request )** и **Сеанс ( Session )**
**Сеанс ( Session )** - долговременный процесс взаимодействия клиента и сервера.
**Запрос ( Request )** - обращение к системе с внешней стороны

**Процесс ( Process )** - контекст выполнения обрабатывания данных от внешней стороны
**Поток вычислений ( Thread )** - активные агенты в контексте одного процесса

Изолированность и устойчивость данных - два решения борьбы с проблемами параллельного выполнения

**Транзакции (transactions)** - основной инструмент управления параллельными процессами
В транзакции либо выполняются все действия, либо ни одного.

### ACID: свойства транзакции
 - Атомарность ( Atomicity )
 - Согласованость ( Consistency )
 - Изолятивность ( Isolation )
 - Устойчивость ( Durability )

### Типовые решения обеспечения параллелизма
 - Оптимистическая атомная блокировка ( Optimistic Offline Lock )
 - Пессимистическая атомная блокировка ( Pessimistic Offline Lock )
 - Блокировка с низкой степенью детализации ( Coarse-Grained Lock )
 - Неявная блокировка ( Implicit Lock )











